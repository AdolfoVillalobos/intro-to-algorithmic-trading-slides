<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Melb Python Meetup - Intro to Algorithmic Trading in Python</title>

		<meta name="description" content="Intro to Algorithmic Trading in Python">
		<meta name="author" content="Adolfo Villalobos">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="../dist/reset.css">
		<link rel="stylesheet" href="../dist/reveal.css">
		<link rel="stylesheet" href="../dist/theme/night.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<!-- <a href="https://revealjs.com">
						<img src="https://static.slid.es/reveal/logo-v1/reveal-white-text.svg" alt="reveal.js logo" style="height: 180px; margin: 0 auto 4rem auto; background: transparent;" class="demo-logo">
					</a> -->
					<h3>Intro to Algorithmic Trading in Python</h3>
					<p>
						<small>by <a href="http://adolfovillalobos.com">Adolfo Villalobos</a> (<a href="htttp://www.orionx.com">@orionx.com</a>)</small>
					</p>
				</section>

				<section id="fragments">
					<h2>About me!</h2>
					<p>I'm a Quantitative Developer/Software Engineer at <a href="https://www.orionx.com">OrionX</a>.</p>
					<p class="fragment">Lead developer: Trading Systems, Data Platforms & Quantitative Research.</p>
					<p class="fragment">I'm also a Python, Open Source and Machine Learning enthusiast.</p>
					<p class="fragment">I have a <a>B.Sc. in Applied Maths</a> and a <a>M.Sc. in Engineering (Data Science)</a>.</p>
					<p class="fragment">6+ years of experience in quant/technology roles.</p>

					<aside class="notes">
						This slide has fragments which are also stepped through in the notes window.
					</aside>
				</section>

				<section id="fragments">
					<h2>This talk is <a>NOT</a> about!</h2>
					<p>Machine Learning/AI</p>
					<p class="fragment">Finance Theory</p>
					<p class="fragment">Blockchains</p>
					<p class="fragment">Financial Advice. Be careful!</p>

				</section>

				<section>
					<h2>Agenda</h2>
					<ul>
						<li>Strategy</li>
						<li>Design</li>
						<li>Demo</li>
						<li>Miscellaneous</li>
					</ul>
				</section>

				<section>
					<h3>Strategy</h3>
					<p class="fragment">A dropshipping analogy</p>
				</section>

				<section>
					<img src="https://adolfovillalobos.imgix.net/dropshipping/1.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section>
					<img src="https://adolfovillalobos.imgix.net/dropshipping/2.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section>
					<img src="https://adolfovillalobos.imgix.net/dropshipping/3.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section>
					<img src="https://adolfovillalobos.imgix.net/dropshipping/4.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section>
					<img src="https://adolfovillalobos.imgix.net/dropshipping/5.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section>
					<img src="https://adolfovillalobos.imgix.net/dropshipping/6.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section id="fragments">
					<h2>Then you</h2>
					<p>Wait...</p>
					<p class="fragment">Run ads</p>
					<p class="fragment">Look for other products</p>
					<p class="fragment">And then...</p>
				</section>
				<section data-background="http://i.giphy.com/90F8aUepslB84.gif">
					<h2>... you SELL!</h2>
				</section>

				<section><
					<img src="https://adolfovillalobos.imgix.net/dropshipping/8.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section style="display: flex; justify-content: center; align-items: center;">
					<img src="https://adolfovillalobos.imgix.net/dropshipping/9.png" alt="Dropshipping" style="width: 100%; height: 100vh; object-fit: contain; background: transparent;" class="demo-logo">
				</section>

				<section data-background="http://i.giphy.com/90F8aUepslB84.gif">
					<h2>... $100 profit!</h2>
				</section>


				<section>
					<h3>Strategy</h3>
					<p class="fragment">Applied to crypto</p>
					<p class="fragment"><a href="https://hummingbot.org/strategies/cross-exchange-market-making/">Liquidity mirroring</a></p>
				</section>

				<section>
					<div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem;">
						<div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
							<div style="height: 200px; display: flex; align-items: center;">
								<img src="https://logos-world.net/wp-content/uploads/2021/02/Kraken-Logo.png" alt="Kraken" style="width: 100%; max-height: 100%; object-fit: contain;">
							</div>
							<ul class="fragment" style="margin-top: 2rem;">
								<li class="fragment"><a href="https://kraken.com">kraken.com</a></li>
								<li class="fragment">Our Alibaba (vendor)</li>
								<li class="fragment"><a>BTC</a>: $60.000 USD</li>
							</ul>
						</div>
						<div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
							<div style="height: 200px; display: flex; align-items: center;">
								<img src="https://adolfovillalobos.imgix.net/blog/Bitfinex Dark.png" alt="Kraken" style="width: 100%; max-height: 100%; object-fit: contain;">
							</div>
							<ul class="fragment" style="margin-top: 2rem;">
								<li class="fragment"><a href="https://bitfinex.com">bitfinex.com</a></li>
								<li class="fragment">Our Shopify (store)</li>
								<li class="fragment"><a>BTC</a>: $70.000 USD</li>
								<li class="fragment" style="color: green;">Expected profit: $1000 USD</li>
							</ul>
						</div>
					</div>
				</section>

				<section id="algorithm">
					<h2>Pseudo-code</h2>
					<pre class="fragment"><code data-line-numbers="1|2-3|5-6|8-12|15-18|19-25" class="hljs" data-trim>while true:
    // Sample prices from Kraken
    btc_price_kraken = get_btc_price("kraken.com")
    
    // Calculate target price with profit margin
    target_price = btc_price_kraken + profit_margin
    
    // Place limit orders on Bitfinex
    if current_orders.empty():
        place_limit_order("bitfinex.com", 
            price=target_price,
            side="sell")
            
    // Compete in orderbook
    competitor_orders = get_orderbook("bitfinex.com")
    if better_price_exists(competitor_orders, target_price):
        update_order_price(target_price - small_adjustment)
        
    // Check if order filled
    if order_filled:
        execute_arbitrage() // Trade against kraken.com
        break</code></pre>
				</section>

				<section data-background="http://i.giphy.com/90F8aUepslB84.gif">
					<h2>... you SELL!</h2>
				</section>

				<section>
					<h3>Design</h3>
					<p class="fragment">Event Driven Architecture</p>
					<p class="fragment">Flow 1: Price Events</p>
					<p class="fragment">Flow 2: Trade Events</p>
				</section>

				<section>
					<h3>Flow 1: Price Events</h3>
				</section>

				<section data-background="https://adolfovillalobos.imgix.net/blog/Liquidity Mirroring Strategy BTC USDT (1).png">
				</section>

				<section>
					<h3>Flow 2: Trade Events</h3>
				</section>

				<section data-background="https://adolfovillalobos.imgix.net/blog/Flow2 Liquidity Mirroring Strategy BTC USDT.png"></section>
				</section>


				<section>
					<h3>Design</h3>
					<p class="fragment">Repo</p>
				</section>

				<section>
					<div style="display: flex; justify-content: space-between; align-items: center;">
						<div style="flex: 1;">
							<img src="https://adolfovillalobos.imgix.net/blog/algo-trading-repo-structure.png" alt="Flow 1" style="width: 100%; object-fit: contain; background: transparent;" class="demo-logo">
						</div>
						<div style="flex: 1; padding-left: 1rem; max-width: 80%; font-size: 0.7em;">
							<ul style="margin: 0; padding: 0 0 0 1.5em;">
								<li class="fragment">Microservices (mono-repo)</li>
								<li class="fragment"><a>price-watch</a>: price events</li>
								<li class="fragment"><a>trade-watch</a>: trade events</li>
								<li class="fragment"><a>place-orders</a>: execute limit/market orders</li>
								<li class="fragment"><a>bot-operator</a>: implement strategy</li>
								<li class="fragment"><a>.github/workflows</a>: CI/CD, testing, etc.</li>
								<li class="fragment"><a>docker-compose.dev.yml</a>: containerize</li>
								<li class="fragment"><a>Makefile</a>: useful commands</li>
							</ul>
						</div>
					</div>
				</section>

				<section>
					<h3>Code</h3>
					<p class="fragment">Price Watch</p>
				</section>

				<section>
					<h2>Price Watch</h2>
					<p>Price source - Strategy design pattern</p>

					<pre><code data-line-numbers="1-2|4-6|8-14|19-25|26-28|29-32" class="hljs" data-trim style="font-size: 0.7em;">
					class PriceSource(BaseModel, ABC):
						"""Abstract base class for different price data sources"""
					
						@abstractmethod
						async def watch_prices(self, symbol: str) -> AsyncIterator[PriceMessage]:
							pass

					import ccxt.pro as ccxt

					class CCXTPriceSource(PriceSource):
						"""Generate prices from a CCXT client"""
					
						exchange: ccxt.Exchange
						exchange_name: str
					
						class Config:
							arbitrary_types_allowed = True
					
						async def watch_prices(self, symbol: str) -> AsyncIterator[PriceMessage]:
							last_message = None
							while True:
								try:
									// Get the orderbook from the exchange
									orderbook = await self.exchange.watch_order_book(symbol)

									// Convert into a PriceMessage
									new_message = PriceMessage.from_orderbook(orderbook, self.exchange_name)
					
									// Yield the new price if it has changeds
									if last_message is None or last_message.has_changed(new_message):
										last_message = new_message
										yield new_message
								except Exception as e:
									logger.error(f"Error watching {symbol}: {e}")
								finally:
									await asyncio.sleep(2)
	</code></pre>
				</section>

				<section>
					<h2>Price Watch</h2>
					<p>RabbitMQ Message queue - Pub/Sub pattern</p>
					<pre><code data-line-numbers="1-5|10-12|14-22|25-28|30-32" class="hljs" data-trim style="font-size: 0.7em;">
						import aio_pika

						class MessageQueuePublisher(BaseModel):
							channel: Optional[aio_pika.Channel] = None
							connection: Optional[aio_pika.Connection] = None
					
							class Config:
								arbitrary_types_allowed = True
						
							async def connect(self, rabbitmq_url: str):
								self.connection = await aio_pika.connect_robust(rabbitmq_url)
								self.channel = await self.connection.channel()
						
							async def publish(self, message: PriceMessage):

								if self.channel is None:
									self.channel = await self.connection.channel()

								logger.info("Publishing price message to %s: %s", message.subject(), message)

								// Convert out price into a RabbitMQ message
								amqp_message = aio_pika.Message(body=message.model_dump_json().encode())

								// Publish the message to the Price subject
								await self.channel.default_exchange.publish(
									amqp_message,
									routing_key=message.subject(), // i.e price_updates_kraken
								)
					
							async def close(self):
								if self.connection:
									await self.connection.close()
				</code></pre>
				</section>

				<section>
					<h2>Price Watch</h2>
					<p>Main loop</p>
					<pre><code data-line-numbers="1-7|9-10|12-14|16-18" class="hljs python" data-trim style="font-size: 0.9em;">

						async def price_service(
							price_source: PriceSource,
							publisher: MessageQueuePublisher,
							symbol: str,
							rabbitmq_url: str,
						) -> None:

							try:
								// Connect to RabbitMQ
								await publisher.connect(rabbitmq_url)

								// Watch prices from the price source
								async for price_message in price_source.watch_prices(symbol):
									await publisher.publish(price_message)

							finally:
								// Close the connection
								await publisher.close()

					</code></pre>
				</section>


				<section>
					<h3>Code</h3>
					<p>Bot operator</p>
				</section>


				<section>
					<h2>Bot operator</h2>
					<p>Event models</p>

					<pre><code data-line-numbers="1-6|8-15|20-29|30-33|35-46" class="hljs python" data-trim style="font-size: 0.8em;">
					class PriceMessage(BaseModel):
						"""Price message from price-watch"""
						symbol: str
						ask_price: float
						bid_price: float
						datetime: datetime
					
					class TradeMessage(BaseModel):
						"""Trade message from trade-watch"""
						symbol: str
						amount: float
						price: float
						exchange: str
						side: str
						datetime: datetime
					
						def subject(self) -> str:
							return f"trade_updates_{self.exchange}"
					
					
					class Order(BaseModel):
						"""Orders sent to place-orders"""
						symbol: str
						quantity: float
						price: Optional[float]
						side: Literal["buy", "sell"]
						exchange: str
						order_type: Literal["market", "limit"]
					
						def subject(self) -> str:
							# limit orders will be sent to order_updates_bitfinex
							# market orders will be sent to order_updates_kraken
							return f"order_updates_{self.exchange}"
					
					
					class Arbitrage(BaseModel):
						target_market: str # BTC/USDT
						origin_market: str # BTC/USDT
						target_exchange: str # bitfinex.com
						origin_exchange: str # kraken.com
						profit_threshold: float # 0.01%
						target_fee: float # 0.1%
						origin_fee: float # 0.2%
					
						def markup(self) -> float:
							return self.profit_threshold + self.target_fee + self.origin_fee
					
					</code></pre>
				</section>


				<section>
					<h2>Bot operator</h2>
					<p>Trading strategy - Strategy design pattern</p>

					<pre><code data-line-numbers="1-4|6-10|12-16|19-24|26-27|29-36|37-44|47-49|50-54|56|59-66" class="hljs python" data-trim style="font-size: 0.7em;">
						class TradingStrategy(ABC):
							"""
							A trading strategy is a class that generates orders based on events.
							"""
						
							@abstractmethod
							def generate_limit_orders(
								self, arbitrage: Arbitrage, price: PriceMessage, amount_to_trade_usdt: float
							) -> list[Order]:
								pass
						
							@abstractmethod
							def generate_market_orders(
								self, arbitrage: Arbitrage, trade_message: TradeMessage
							) -> list[Order]:
								pass
						
						
						class SimpleStrategy(TradingStrategy):
							def generate_limit_orders(
								self, arbitrage: Arbitrage, price: PriceMessage, amount_to_trade_usdt: float
							) -> list[Order]:
								ask_price = price.ask_price * (1.0 + arbitrage.markup())
								bid_price = price.bid_price * (1.0 - arbitrage.markup())
						
								ask_quantity = amount_to_trade_usdt / ask_price
								bid_quantity = amount_to_trade_usdt / bid_price
								return [
									Order(
										symbol=arbitrage.target_market,
										quantity=bid_quantity,
										price=bid_price,
										side="buy",
										exchange=arbitrage.target_exchange,
										order_type="limit",
									),
									Order(
										symbol=arbitrage.target_market,
										quantity=ask_quantity,
										price=ask_price,
										side="sell",
										exchange=arbitrage.target_exchange,
										order_type="limit",
									),
								]
						
							def generate_market_orders(
								self, arbitrage: Arbitrage, trade_message: TradeMessage
							) -> list[Order]:
								if trade_message.symbol != arbitrage.target_market:
									return []
						
								if trade_message.exchange != arbitrage.target_exchange:
									return []
						
								oposite_side = "buy" if trade_message.side == "sell" else "sell"
						
								return [
									Order(
										symbol=arbitrage.origin_market,
										quantity=trade_message.amount,
										price=None,
										side=oposite_side,
										exchange=arbitrage.origin_exchange,
										order_type="market",
									)
								]
						

	</code></pre>
				</section>


				<section>
					<h2>Bot operator</h2>
					<p>Event observer - Observer design pattern</p>

					<pre><code data-line-numbers="1-2|3-5|7-9|11-19|43|47-48|50-53|55-56|60-61|63|67-68|70-71|73-74|78-79|81|82-85|87-90" class="hljs python" data-trim style="font-size: 0.7em;">						
						class EventObserver(ABC):
							"""Abstract base class for different event observers"""
							@abstractmethod
							async def on_price_update(self, message: aio_pika.IncomingMessage):
								pass
						
							@abstractmethod
							async def on_trade_update(self, message: aio_pika.IncomingMessage):
								pass
						
						
						class ArbitrageObserver(EventObserver, BaseModel):
							"""Arbitrage observer: listens to price and trade events and makes trading decisions"""
							arbitrage: Arbitrage
							strategy: TradingStrategy
							channel: aio_pika.Channel | None = None
							connection: aio_pika.Connection | None = None
							amount_to_trade_usdt: float
						
							class Config:
								arbitrary_types_allowed = True
						
							async def connect(self, rabbitmq_url: str):
								self.connection = await aio_pika.connect_robust(rabbitmq_url)
								self.channel = await self.connection.channel()
						
							def target_exchange(self) -> str:
								return self.arbitrage.target_exchange
						
							def origin_exchange(self) -> str:
								return self.arbitrage.origin_exchange
						
							async def _publish_order(self, order: Order):
								if not self.channel:
									raise RuntimeError("Channel not initialized")
								subject = order.subject()
								await self.channel.default_exchange.publish(
									aio_pika.Message(body=order.model_dump_json().encode()),
									routing_key=subject,
								)
								logger.info("New decision to %s: %s", subject, order)
						
							async def on_price_update(self, message: aio_pika.IncomingMessage):
								try:
									logger.info("Received price update from %s", message.routing_key)

									# Convert the RabbitMQ message into a PriceMessage
									price = PriceMessage(**json.loads(message.body))

									# Generate limit orders based on the price update
									orders = self.strategy.generate_limit_orders(
										self.arbitrage, price, self.amount_to_trade_usdt
									)
						
									for order in orders:
										await self._publish_order(order)
								except Exception as e:
									logger.error("Error processing price update: %s", e)
						
								finally:
									await message.ack()
						
							async def on_trade_update(self, message: aio_pika.IncomingMessage):
								try:
									logger.info("Received trade update from %s", message.routing_key)

									# Convert the RabbitMQ message into a TradeMessage
									trade_message = TradeMessage(**json.loads(message.body))

									# Generate market orders based on the trade update
									orders = self.strategy.generate_market_orders(self.arbitrage, trade_message)
						
									for order in orders:
										await self._publish_order(order)
								except Exception as e:
									logger.error("Error processing trade update: %s", e)
						
								finally:
									await message.ack()
						
							async def subscribe(self):
								# Consume price updates from the origin exchange (kraken)
								price_subject = f"price_updates_{self.arbitrage.origin_exchange}"
								price_queue = await self.channel.declare_queue(price_subject)
								await price_queue.consume(self.on_price_update)
						
								# Consume trade updates from the target exchange (bitfinex)
								trade_subject = f"trade_updates_{self.arbitrage.target_exchange}"
								trade_queue = await self.channel.declare_queue(trade_subject)
								await trade_queue.consume(self.on_trade_update)

								await asyncio.Future()

								#
						
					</code></pre>
				</section>

				<section>
					<h3>Bot operator</h3>
					<p>Main loop</p>
					<pre><code data-line-numbers="1-25|1-2|4-12|14-18|19|20" class="hljs python" data-trim data-noescape>
					async def operator_service():
						"""Bot operator service"""

						arbitrage = Arbitrage(
							target_market="BTC/USDT",
							origin_market="BTC/USDT",
							target_exchange="bitfinex",
							origin_exchange="kraken",
							profit_threshold=0.05,
							target_fee=0.002,
							origin_fee=0.001,
						)
					
						observer = ArbitrageObserver(
							arbitrage=arbitrage,
							strategy=SimpleStrategy(),
							amount_to_trade_usdt=15.0,
						)
						await observer.connect("amqp://guest:guest@rabbitmq/")
						await observer.subscribe()
					
					
					if __name__ == "__main__":
						asyncio.run(operator_service())
					
</code></pre>
				</section>

				<section>
					<h3>Demo</h3>
				</section>

				<section>
					<h2>Thanks! The END</h2>
					<div style="display: flex; justify-content: center; gap: 8rem;">
						<div style="text-align: center;">
							<img src="https://adolfovillalobos.imgix.net/blog/QR%20Linkedin.png" alt="LinkedIn QR code" style="height: 180px; background: transparent;" class="demo-logo">
							<p><small>LinkedIn</small></p>
						</div>
						<div style="text-align: center;">
							<img src="https://adolfovillalobos.imgix.net/blog/QR%20GitHub%20500x500.png" alt="GitHub QR code" style="height: 180px; background: transparent;" class="demo-logo">
							<p><small>GitHub Repo</small></p>
						</div>
					</div>
				</section>


			</div>

		</div>

		<script src="../dist/reveal.js"></script>
		<script src="../plugin/zoom/zoom.js"></script>
		<script src="../plugin/notes/notes.js"></script>
		<script src="../plugin/search/search.js"></script>
		<script src="../plugin/markdown/markdown.js"></script>
		<script src="../plugin/highlight/highlight.js"></script>
		<script>

			// Also available as an ES module, see:
			// https://revealjs.com/initialization/
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
			});

		</script>

	</body>
</html>
